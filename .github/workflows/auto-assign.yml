name: Auto-assign Issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  assign-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Assign issue automatically (round-robin + solo asignables)
        uses: actions/github-script@v7
        env:
          TEAM_MEMBERS: AtomicBanana23, marigj12, Scarkat, Joaquower
        with:
          script: |
            const team = (process.env.TEAM_MEMBERS || "")
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);

            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;

            // Usuarios asignables del repo
            const assignables = await github.paginate(
              github.rest.issues.listAssignees,
              { owner, repo, per_page: 100 }
            );
            const assignableSet = new Set(assignables.map(u => u.login.toLowerCase()));

            // Round-robin iniciando por el número del issue
            let assignee = null;
            if (team.length > 0) {
              const start = issueNumber % team.length;
              for (let i = 0; i < team.length; i++) {
                const candidate = team[(start + i) % team.length];
                if (assignableSet.has(candidate.toLowerCase())) {
                  assignee = candidate;
                  break;
                }
              }
            }

            // Fallback: si nadie del team es asignable, asigna al creador
            // Si prefieres dejarlo SIN asignar, comenta las 2 líneas siguientes.
            if (!assignee) {
              assignee = context.payload.issue.user.login;
            }

            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number: issueNumber,
              assignees: [assignee],
            });
            core.info(`Assigned #${issueNumber} to ${assignee}`);
